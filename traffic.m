%% TSR system using Transfer learning
%%import images as the imagedatastore object. Specify the folder name as
%%the label.
    imds1 = imageDatastore('Ahead only', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds2 = imageDatastore('Bend to left', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds3 = imageDatastore('Bend to right', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds4 = imageDatastore('Crossroads', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds5 = imageDatastore('Cycle route ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds6 = imageDatastore('Distance to ‘Give Way’ line ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds7 = imageDatastore('Double bend first to left', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds8 = imageDatastore('End of minimum speed 80', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds9 = imageDatastore('End of no-overtaking zone', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds10 = imageDatastore('End of no-overtaking zone over 3.5t ', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds11 = imageDatastore('Keep left', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds12 = imageDatastore('Keep right', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds13 = imageDatastore('Maximum speed 20', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds14 = imageDatastore('Maximum speed 30', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds15 = imageDatastore('Maximum speed 50', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds16 = imageDatastore('Maximum speed 60', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds17 = imageDatastore('Maximum speed 70', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds18 = imageDatastore('Maximum speed 80', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds19 = imageDatastore('Maximum speed 100', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds20 = imageDatastore('Maximum speed 120', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds21 = imageDatastore('Mini-roundabout', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds22 = imageDatastore('National speed limit applies', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds23 = imageDatastore('No entry for vehicular traffic', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds24 = imageDatastore('No overtaking', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds25 = imageDatastore('No overtaking over 3.5t', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds26 = imageDatastore('No vehicle', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds27 = imageDatastore('No vehicles except bicycles being pushed', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds28 = imageDatastore('Other danger', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds29 = imageDatastore('Oxidizing substance', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds30 = imageDatastore('Risk of snow or ice', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds31 = imageDatastore('Road narrows on right', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds32 = imageDatastore('Road works', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds33 = imageDatastore('School crossing patrol ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds34 = imageDatastore('Soft verges', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds35 = imageDatastore('STOP', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds36 = imageDatastore('Traffic signals', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds37 = imageDatastore('Turn left or ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds38 = imageDatastore('Turn right or ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds39 = imageDatastore('Turn left ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds40 = imageDatastore('Turn right ahead', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds41 = imageDatastore('Uneven road', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds42 = imageDatastore('Wild animals', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds43 = imageDatastore('Zebra crossing', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');
    imds44 = imageDatastore('Cannot recognize', ...
    'IncludeSubfolders',true, ...
    'LabelSource','foldernames');


%% Cross Validation
%In each category,every 30 images come from the same video,so the number of
%images contained in each category is a multiple of 30.Here we use 5-fold
%cross validation.Split a number of sequences from each category.Here
%will be some uneven distribution due to the number of images.For example
%210 images can be splitted into 7 sequences,but they can't be evenly 
%assigned to five training sessions.
    [S11,S12,S13,S14,S15] = splitEachLabel(imds1,1/5,1/5,1/5,1/5);
    [S21,S22,S23,S24,S25,S26,S27] = splitEachLabel(imds2,1/7,1/7,1/7,1/7,1/7,1/7);
    [S31,S32,S33,S34,S35,S36] = splitEachLabel(imds3,1/6,1/6,1/6,1/6,1/6);
    [S41,S42,S43,S44,S45,S46,S47,S48,S49,S410,S411] = splitEachLabel(imds4,1/11,1/11,1/11,1/11,...
    1/11,1/11,1/11,1/11,1/11,1/11);
    [S51,S52,S53,S54,S55,S56,S57,S58,S59] = splitEachLabel(imds5,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9);
    [S61,S62,S63,S64,S65,S66,S67,S68,S69] = splitEachLabel(imds6,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9);
    [S71,S72,S73,S74,S75,S76,S77,S78,S79,S710,S711] = splitEachLabel(imds7,1/11,1/11,1/11,1/11,...
    1/11,1/11,1/11,1/11,1/11,1/11);
    [S81,S82,S83,S84,S85,S86,S87,S88,S89,S810,S811,S812,S813,S814] = splitEachLabel(imds8,1/14,...
    1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14);
    [S91,S92,S93,S94,S95,S96,S97,S98] = splitEachLabel(imds9,1/8,1/8,1/8,1/8,1/8,1/8,1/8);
    [S101,S102,S103,S104,S105,S106,S107,S108] = splitEachLabel(imds10,1/8,1/8,1/8,1/8,1/8,1/8,1/8);
    [S111,S112,S113,S114,S115] = splitEachLabel(imds11,1/5,1/5,1/5,1/5);
    [S121,S122,S123,S124,S125,S126,S127,S128,S129,S1210,...
    S1211,S1212,S1213,S1214,S1215,S1216,S1217,S1218,S1219,S1220,...
    S1221,S1222,S1223] = splitEachLabel(imds12,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,...
    1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23);
    [S131,S132,S133,S134,S135,S136,S137] = splitEachLabel(imds13,1/7,1/7,1/7,1/7,1/7,1/7);
    [S141,S142,S143,S144,S145,S146,S147,S148,S149,S1410,...
    S1411,S1412,S1413,S1414,S1415,S1416,S1417,S1418,S1419,S1420,...
    S1421,S1422,S1423,S1424,S1425,S1426,S1427,S1428,S1429,S1430,...
    S1431,S1432,S1433,S1434,S1435,S1436,S1437] = splitEachLabel(imds14,1/37,1/37,1/37,1/37,1/37,1/37,...
    1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,...
    1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37);
    [S151,S152,S153,S154,S155] = splitEachLabel(imds15,1/5,1/5,1/5,1/5);
    [S161,S162,S163,S164,S165,S166,S167,S168,S169,S1610,...
    S1611,S1612,S1613,S1614,S1615,S1616,S1617,S1618,S1619,S1620,...
    S1621,S1622,S1623,S1624,S1625,S1626,S1627,S1628,S1629,S1630,...
    S1631,S1632,S1633,S1634,S1635,S1636,S1637,S1638,S1639,S1640,S1641,S1642,...
    S1643,S1644,S1645,S1646,S1647] = splitEachLabel(imds16,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,...
    1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,...
    1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47);
    [S171,S172,S173,S174,S175,S176] = splitEachLabel(imds17,1/6,1/6,1/6,1/6,1/6);
    [S181,S182,S183,S184,S185,S186,S187,S188,S189,S1810,...
    S1811,S1812,S1813,S1814,S1815,S1816,S1817,S1818,S1819,S1820,...
    S1821,S1822,S1823,S1824,S1825,S1826,S1827,S1828,S1829,S1830,S1831] = splitEachLabel(imds18,1/31,...
    1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,...
    1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31,1/31);    
    [S191,S192,S193,S194,S195,S196,S197,S198] = splitEachLabel(imds19,1/8,1/8,1/8,1/8,1/8,1/8,1/8);
    [S201,S202,S203,S204,S205,S206,S207,S208,S209,S2010,...
    S2011,S2012,S2013,S2014,S2015,S2016,S2017,S2018,S2019,S2020,...
    S2021,S2022,S2023,S2024,S2025,S2026,S2027,S2028,S2029,S2030,...
    S2031,S2032,S2033,S2034,S2035,S2036,S2037,S2038,S2039,S2040,...
    S2041,S2042,S2043,S2044,S2045,S2046,S2047] = splitEachLabel(imds20,1/47,1/47,1/47,1/47,1/47,1/47,...
    1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,...
    1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47,1/47);
    [S211,S212,S213,S214,S215,S216] = splitEachLabel(imds21,1/6,1/6,1/6,1/6,1/6);
    [S221,S222,S223,S224,S225,S226,S227,S228] = splitEachLabel(imds22,1/8,1/8,1/8,1/8,1/8,1/8,1/8);
    [S231,S232,S233,S234,S235,S236,S237,S238,S239,S2310,...
    S2311,S2312,S2313,S2314,S2315,S2316,S2317,S2318,S2319,S2320,...
    S2321,S2322,S2323,S2324,S2325,S2326,S2327,S2328,S2329,S2330,...
    S2331,S2332,S2333,S2334,S2335,S2336,S2337] = splitEachLabel(imds23,1/37,1/37,1/37,1/37,1/37,1/37,...
    1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,...
    1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37,1/37);   
    [S241,S242,S243,S244,S245,S246,S247] = splitEachLabel(imds24,1/7,1/7,1/7,1/7,1/7,1/7);
    [S251,S252,S253,S254,S255,S256,S257,S258,S259,S2510,...
    S2511,S2512,S2513,S2514,S2515,S2516,S2517,S2518,S2519,S2520,...
    S2521,S2522,S2523,S2524,S2525,S2526,S2527,S2528,S2529,S2530,...
    S2531,S2532,S2533,S2534,S2535,S2536,S2537,S2538,S2539,S2540,...
    S2541,S2542,S2543,S2544,S2545,S2546,S2547,S2548,S2549,S2550,...
    S2551,S2552,S2553,S2554,S2555,S2556,S2557,S2558,S2559,S2560,...
    S2561,S2562,S2563,S2564,S2565,S2566,S2567] = splitEachLabel(imds25,1/67,1/67,1/67,1/67,1/67,1/67,...
    1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,...
    1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,...
    1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,1/67,...
    1/67,1/67,1/67);    
    [S261,S262,S263,S264,S265,S266,S267,S268,S269,S2610,S2611,S2612,S2613,S2614] = splitEachLabel(imds26,...
    1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14);
    [S271,S272,S273,S274,S275,S276,S277] = splitEachLabel(imds27,1/7,1/7,1/7,1/7,1/7,1/7);
    [S281,S282,S283,S284,S285] = splitEachLabel(imds28,1/5,1/5,1/5,1/5);
    [S291,S292,S293,S294,S295,S296,S297] = splitEachLabel(imds29,1/7,1/7,1/7,1/7,1/7,1/7);
    [S301,S302,S303,S304,S305] = splitEachLabel(imds30,1/5,1/5,1/5,1/5);
    [S311,S312,S313,S314,S315,S316,S317,S318,S319] = splitEachLabel(imds31,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9);
    [S321,S322,S323,S324,S325] = splitEachLabel(imds32,1/5,1/5,1/5,1/5);
    [S331,S332,S333,S334,S335,S336,S337,S338,S339] = splitEachLabel(imds33,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9);    
    [S341,S342,S343,S344,S345,S346,S347,S348,S349,S3410,...
    S3411,S3412,S3413,S3414,S3415,S3416,S3417] = splitEachLabel(imds34,1/17,1/17,1/17,1/17,1/17,...
    1/17,1/17,1/17,1/17,1/17,1/17,1/17,1/17,1/17,1/17,1/17);
    [S351,S352,S353,S354,S355,S356,S357,S358,S359,S3510,S3511,S3512,S3513] = splitEachLabel(imds35,...
    1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13);
    [S361,S362,S363,S364,S365] = splitEachLabel(imds36,1/5,1/5,1/5,1/5);
    [S371,S372,S373,S374,S375,S376,S377] = splitEachLabel(imds37,1/7,1/7,1/7,1/7,1/7,1/7);
    [S381,S382,S383,S384,S385,S386,S387,S388,S389,S3810,S3811,S3812,S3813] = splitEachLabel(imds38,...
    1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13);
    [S391,S392,S393,S394,S395,S396,S397,S398,S399,S3910,S3911,S3912,S3913,S3914] = splitEachLabel(imds39,...
    1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14,1/14);
    [S401,S402,S403,S404,S405,S406,S407,S408,S409,S4010,...
    S4011,S4012,S4013,S4014,S4015,S4016,S4017,S4018,S4019,S4020,...
    S4021,S4022,S4023] = splitEachLabel(imds40,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,...
    1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23,1/23);
    [s411,S412,S413,S414,S415,S416,S417,S418,S419,S4110,S4111,S4112,S4113] = splitEachLabel(imds41,...
    1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13);
    [S421,S422,S423,S424,S425,S426,S427,S428,S429,S4210,S4211,S4212,S4213] = splitEachLabel(imds42,...
    1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13,1/13);
    [S431,S432,S433,S434,S435,S436,S437,S438] = splitEachLabel(imds43,1/8,1/8,1/8,1/8,1/8,1/8,1/8);
    [S441,S442,S443,S444,S445] = splitEachLabel(imds44,1/5,1/5,1/5,1/5);
    %Extract some sequences in each class,recombine them into new Imagedatastore
    p1 = imageDatastore(cat(1,...
    S11.Files,...
    S21.Files,S22.Files,...
    S31.Files,...
    S41.Files,S42.Files,S43.Files,...
    S51.Files,S52.Files,...
    S61.Files,S62.Files,...
    S71.Files,S72.Files,S73.Files,...
    S81.Files,S82.Files,S83.Files,...
    S91.Files,S92.Files,...
    S101.Files,S102.Files,...
    S111.Files,...
    S121.Files,S122.Files,S123.Files,S124.Files,S125.Files,...
    S131.Files,S132.Files,...
    S141.Files,S142.Files,S143.Files,S144.Files,S145.Files,S146.Files,S147.Files,S148.Files,...
    S151.Files,...
    S161.Files,S162.Files,S163.Files,S164.Files,S165.Files,S166.Files,S167.Files,S168.Files,S169.Files,S1610.Files,...
    S171.Files,...
    S181.Files,S182.Files,S183.Files,S184.Files,S185.Files,S186.Files,S187.Files,...
    S191.Files,S192.Files,...
    S201.Files,S202.Files,S203.Files,S204.Files,S205.Files,S206.Files,S207.Files,S208.Files,S209.Files,S2010.Files,...
    S211.Files,S212.Files,...
    S221.Files,S222.Files,...
    S231.Files,S232.Files,S233.Files,S234.Files,S235.Files,S236.Files,S237.Files,S238.Files,...
    S241.Files,S242.Files,...
    S251.Files,S252.Files,S253.Files,S254.Files,S255.Files,S256.Files,S257.Files,S258.Files,...
    S259.Files,S2510.Files,S2511.Files,S2512.Files,S2513.Files,S2514.Files,...
    S261.Files,S262.Files,S263.Files,...
    S271.Files,S272.Files,...
    S281.Files,...
    S291.Files,...
    S301.Files,...
    S311.Files,S312.Files,...
    S321.Files,...
    S331.Files,S332.Files,...
    S341.Files,S342.Files,S343.Files,...
    S351.Files,S352.Files,...
    S361.Files,...
    S371.Files,...
    S381.Files,S382.Files,...
    S391.Files,S392.Files,...
    S401.Files,S402.Files,S403.Files,S404.Files,...
    s411.Files,S412.Files,...
    S421.Files,S422.Files,...
    S431.Files,...
    S441.Files));

    p2 = imageDatastore(cat(1,...
    S12.Files,...
    S23.Files,...
    S32.Files,...
    S44.Files,S45.Files,...
    S53.Files,S54.Files,...
    S63.Files,S64.Files,...
    S74.Files,S75.Files,...
    S84.Files,S85.Files,S86.Files,...
    S93.Files,...
    S103.Files,...
    S112.Files,...
    S126.Files,S127.Files,S128.Files,S129.Files,...
    S133.Files,...
    S149.Files,S1410.Files,S1411.Files,S1412.Files,S1413.Files,S1414.Files,S1415.Files,S1416.Files,...
    S152.Files,...
    S1611.Files,S1612.Files,S1613.Files,S1614.Files,S1615.Files,S1616.Files,S1617.Files,S1618.Files,S1619.Files,...
    S172.Files,S173.Files,...
    S188.Files,S189.Files,S1810.Files,S1811.Files,S1812.Files,S1813.Files,...
    S193.Files,...
    S2011.Files,S2012.Files,S2013.Files,S2014.Files,S2015.Files,S2016.Files,S2017.Files,S2018.Files,S2019.Files,...
    S213.Files,...
    S223.Files,...
    S239.Files,S2310.Files,S2311.Files,S2312.Files,S2313.Files,S2314.Files,S2315.Files,...
    S243.Files,...
    S2515.Files,S2516.Files,S2517.Files,S2518.Files,S2519.Files,S2520.Files,S2521.Files,S2522.Files,...
    S2523.Files,S2524.Files,S2525.Files,S2526.Files,S2527.Files,S2528.Files,...
    S264.Files,S265.Files,S266.Files,...
    S273.Files,...
    S282.Files,...
    S293.Files,S294.Files,...
    S302.Files,...
    S313.Files,S314.Files,...
    S322.Files,...
    S333.Files,S334.Files,...
    S344.Files,S345.Files,S346.Files,S347.Files,...
    S353.Files,S354.Files,...
    S362.Files,...
    S372.Files,S373.Files,...
    S383.Files,S384.Files,S385.Files,...
    S393.Files,S394.Files,S395.Files,...
    S405.Files,S406.Files,S407.Files,S408.Files,S409.Files,...
    S413.Files,S414.Files,...
    S423.Files,S424.Files,...
    S432.Files,...
    S442.Files));

    p3 = imageDatastore(cat(1,...
    S13.Files,...
    S24.Files,...
    S33.Files,...
    S46.Files,S47.Files,...
    S55.Files,S56.Files,...
    S65.Files,S66.Files,...
    S76.Files,S77.Files,...
    S87.Files,S88.Files,S89.Files,...
    S94.Files,S95.Files,...
    S104.Files,S105.Files,...
    S113.Files,...
    S1210.Files,S1211.Files,S1212.Files,S1213.Files,S1214.Files,...
    S134.Files,...
    S1417.Files,S1418.Files,S1419.Files,S1420.Files,S1421.Files,S1422.Files,S1423.Files,...
    S153.Files,...
    S1620.Files,S1621.Files,S1622.Files,S1623.Files,S1624.Files,S1625.Files,S1626.Files,S1627.Files,S1628.Files,...
    S174.Files,...
    S1814.Files,S1815.Files,S1816.Files,S1817.Files,S1818.Files,S1819.Files,...
    S194.Files,...
    S2020.Files,S2021.Files,S2022.Files,S2023.Files,S2024.Files,S2025.Files,S2026.Files,S2027.Files,S2028.Files,...
    S214.Files,...
    S224.Files,S225.Files,...
    S2316.Files,S2317.Files,S2318.Files,S2319.Files,S2320.Files,S2321.Files,S2322.Files,...
    S244.Files,...
    S2529.Files,S2530.Files,S2531.Files,S2532.Files,S2533.Files,S2534.Files,S2535.Files,S2536.Files,...
    S2537.Files,S2538.Files,S2539.Files,S2540.Files,S2541.Files,...
    S267.Files,S268.Files,S269.Files,...
    S274.Files,...
    S283.Files,...
    S292.Files,...
    S303.Files,...
    S315.Files,...
    S323.Files,...
    S335.Files,S336.Files,...
    S348.Files,S349.Files,S3410.Files,...
    S355.Files,S356.Files,...
    S363.Files,...
    S374.Files,...
    S386.Files,S387.Files,...
    S396.Files,S397.Files,S398.Files,...
    S4010.Files,S4011.Files,S4012.Files,S4013.Files,...
    S415.Files,S416.Files,...
    S425.Files,S426.Files,S427.Files,...
    S433.Files,S434.Files,...
    S443.Files));

    p4 = imageDatastore(cat(1,...
    S14.Files,...
    S25.Files,S26.Files,...
    S34.Files,S35.Files,...
    S48.Files,S49.Files,...
    S57.Files,...
    S67.Files,...
    S78.Files,S79.Files,...
    S810.Files,S811.Files,S812.Files,...
    S96.Files,S97.Files,...
    S106.Files,...
    S114.Files,...
    S1215.Files,S1216.Files,S1217.Files,S1218.Files,S1219.Files,...
    S135.Files,S136.Files,...
    S1424.Files,S1425.Files,S1426.Files,S1427.Files,S1428.Files,S1429.Files,S1430.Files,...
    S154.Files,...
    S1629.Files,S1630.Files,S1631.Files,S1632.Files,S1633.Files,S1634.Files,S1635.Files,S1636.Files,S1637.Files,...
    S175.Files,...
    S1820.Files,S1821.Files,S1822.Files,S1823.Files,S1824.Files,S1825.Files,...
    S195.Files,S196.Files,...
    S2029.Files,S2030.Files,S2031.Files,S2032.Files,S2033.Files,S2034.Files,S2035.Files,S2036.Files,S2037.Files,...
    S215.Files,...
    S226.Files,S227.Files,...
    S2323.Files,S2324.Files,S2325.Files,S2326.Files,S2327.Files,S2328.Files,S2329.Files,...
    S245.Files,S246.Files,...
    S2542.Files,S2543.Files,S2544.Files,S2545.Files,S2546.Files,S2547.Files,S2548.Files,S2549.Files,...
    S2550.Files,S2551.Files,S2552.Files,S2553.Files,S2554.Files,...
    S2610.Files,S2611.Files,S2612.Files,...
    S275.Files,S276.Files,...
    S284.Files,...
    S295.Files,...
    S304.Files,...
    S316.Files,S317.Files,...
    S324.Files,...
    S337.Files,S338.Files,...
    S3411.Files,S3412.Files,S3413.Files,...
    S357.Files,S358.Files,S359.Files,...
    S364.Files,...
    S375.Files,...
    S388.Files,S389.Files,S3810.Files,...
    S399.Files,S3910.Files,S3911.Files,...
    S4014.Files,S4015.Files,S4016.Files,S4017.Files,S4018.Files,...
    S417.Files,S418.Files,S419.Files,...
    S428.Files,S429.Files,S4210.Files,...
    S435.Files,S436.Files,...
    S444.Files));

    p5 = imageDatastore(cat(1,...
    S15.Files,...
    S27.Files,...
    S36.Files,...
    S410.Files,S411.Files,...
    S58.Files,S59.Files,...
    S68.Files,S69.Files,...
    S710.Files,S711.Files,...
    S813.Files,S814.Files,...
    S98.Files,...
    S107.Files,S108.Files,...
    S115.Files,...
    S1220.Files,S1221.Files,S1222.Files,S1223.Files,...
    S137.Files,...
    S1431.Files,S1432.Files,S1433.Files,S1434.Files,S1435.Files,S1436.Files,S1437.Files,...
    S155.Files,...
    S1638.Files,S1639.Files,S1640.Files,S1641.Files,S1642.Files,S1643.Files,S1644.Files,S1645.Files,S1646.Files,S1647.Files,...
    S176.Files,...
    S1826.Files,S1827.Files,S1828.Files,S1829.Files,S1830.Files,S1831.Files,...
    S197.Files,S198.Files,...
    S2038.Files,S2039.Files,S2040.Files,S2041.Files,S2042.Files,S2043.Files,S2044.Files,S2045.Files,S2046.Files,S2047.Files,...
    S216.Files,...
    S228.Files,...
    S2330.Files,S2331.Files,S2332.Files,S2333.Files,S2334.Files,S2335.Files,S2336.Files,S2337.Files,...
    S247.Files,...
    S2555.Files,S2556.Files,S2557.Files,S2558.Files,S2559.Files,S2560.Files,...
    S2561.Files,S2562.Files,S2563.Files,S2564.Files,S2565.Files,S2566.Files,S2567.Files,...
    S2613.Files,S2614.Files,...
    S277.Files,...
    S285.Files,...
    S296.Files,S297.Files,...
    S305.Files,...
    S318.Files,S319.Files,...
    S325.Files,...
    S339.Files,...
    S3414.Files,S3415.Files,S3416.Files,S3417.Files,...
    S3510.Files,S3511.Files,S3512.Files,S3513.Files,...
    S365.Files,...
    S376.Files,S377.Files,...
    S3811.Files,S3812.Files,S3813.Files,...
    S3912.Files,S3913.Files,S3914.Files,...
    S4019.Files,S4020.Files,S4021.Files,S4022.Files,S4023.Files,...
    S4110.Files,S4111.Files,S4112.Files,S4113.Files,...
    S4211.Files,S4212.Files,S4213.Files,...
    S437.Files,S438.Files,...
    S445.Files));

    p1.Labels = cat(1,...
    S11.Labels,...
    S21.Labels,S22.Labels,...
    S31.Labels,...
    S41.Labels,S42.Labels,S43.Labels,...
    S51.Labels,S52.Labels,...
    S61.Labels,S62.Labels,...
    S71.Labels,S72.Labels,S73.Labels,...
    S81.Labels,S82.Labels,S83.Labels,...
    S91.Labels,S92.Labels,...
    S101.Labels,S102.Labels,...
    S111.Labels,...
    S121.Labels,S122.Labels,S123.Labels,S124.Labels,S125.Labels,...
    S131.Labels,S132.Labels,...
    S141.Labels,S142.Labels,S143.Labels,S144.Labels,S145.Labels,S146.Labels,S147.Labels,S148.Labels,...
    S151.Labels,...
    S161.Labels,S162.Labels,S163.Labels,S164.Labels,S165.Labels,S166.Labels,S167.Labels,S168.Labels,S169.Labels,S1610.Labels,...
    S171.Labels,...
    S181.Labels,S182.Labels,S183.Labels,S184.Labels,S185.Labels,S186.Labels,S187.Labels,...
    S191.Labels,S192.Labels,...
    S201.Labels,S202.Labels,S203.Labels,S204.Labels,S205.Labels,S206.Labels,S207.Labels,S208.Labels,S209.Labels,S2010.Labels,...
    S211.Labels,S212.Labels,...
    S221.Labels,S222.Labels,...
    S231.Labels,S232.Labels,S233.Labels,S234.Labels,S235.Labels,S236.Labels,S237.Labels,S238.Labels,...
    S241.Labels,S242.Labels,...
    S251.Labels,S252.Labels,S253.Labels,S254.Labels,S255.Labels,S256.Labels,S257.Labels,S258.Labels,...
    S259.Labels,S2510.Labels,S2511.Labels,S2512.Labels,S2513.Labels,S2514.Labels,...
    S261.Labels,S262.Labels,S263.Labels,...
    S271.Labels,S272.Labels,...
    S281.Labels,...
    S291.Labels,...
    S301.Labels,...
    S311.Labels,S312.Labels,...
    S321.Labels,...
    S331.Labels,S332.Labels,...
    S341.Labels,S342.Labels,S343.Labels,...
    S351.Labels,S352.Labels,...
    S361.Labels,...
    S371.Labels,...
    S381.Labels,S382.Labels,...
    S391.Labels,S392.Labels,...
    S401.Labels,S402.Labels,S403.Labels,S404.Labels,...
    s411.Labels,S412.Labels,...
    S421.Labels,S422.Labels,...
    S431.Labels,...
    S441.Labels);

    p2.Labels = cat(1,...
    S12.Labels,...
    S23.Labels,...
    S32.Labels,...
    S44.Labels,S45.Labels,...
    S53.Labels,S54.Labels,...
    S63.Labels,S64.Labels,...
    S74.Labels,S75.Labels,...
    S84.Labels,S85.Labels,S86.Labels,...
    S93.Labels,...
    S103.Labels,...
    S112.Labels,...
    S126.Labels,S127.Labels,S128.Labels,S129.Labels,...
    S133.Labels,...
    S149.Labels,S1410.Labels,S1411.Labels,S1412.Labels,S1413.Labels,S1414.Labels,S1415.Labels,S1416.Labels,...
    S152.Labels,...
    S1611.Labels,S1612.Labels,S1613.Labels,S1614.Labels,S1615.Labels,S1616.Labels,S1617.Labels,S1618.Labels,S1619.Labels,...
    S172.Labels,S173.Labels,...
    S188.Labels,S189.Labels,S1810.Labels,S1811.Labels,S1812.Labels,S1813.Labels,...
    S193.Labels,...
    S2011.Labels,S2012.Labels,S2013.Labels,S2014.Labels,S2015.Labels,S2016.Labels,S2017.Labels,S2018.Labels,S2019.Labels,...
    S213.Labels,...
    S223.Labels,...
    S239.Labels,S2310.Labels,S2311.Labels,S2312.Labels,S2313.Labels,S2314.Labels,S2315.Labels,...
    S243.Labels,...
    S2515.Labels,S2516.Labels,S2517.Labels,S2518.Labels,S2519.Labels,S2520.Labels,S2521.Labels,S2522.Labels,...
    S2523.Labels,S2524.Labels,S2525.Labels,S2526.Labels,S2527.Labels,S2528.Labels,...
    S264.Labels,S265.Labels,S266.Labels,...
    S273.Labels,...
    S282.Labels,...
    S293.Labels,S294.Labels,...
    S302.Labels,...
    S313.Labels,S314.Labels,...
    S322.Labels,...
    S333.Labels,S334.Labels,...
    S344.Labels,S345.Labels,S346.Labels,S347.Labels,...
    S353.Labels,S354.Labels,...
    S362.Labels,...
    S372.Labels,S373.Labels,...
    S383.Labels,S384.Labels,S385.Labels,...
    S393.Labels,S394.Labels,S395.Labels,...
    S405.Labels,S406.Labels,S407.Labels,S408.Labels,S409.Labels,...
    S413.Labels,S414.Labels,...
    S423.Labels,S424.Labels,...
    S432.Labels,...
    S442.Labels);


    p3.Labels = cat(1,...
    S13.Labels,...
    S24.Labels,...
    S33.Labels,...
    S46.Labels,S47.Labels,...
    S55.Labels,S56.Labels,...
    S65.Labels,S66.Labels,...
    S76.Labels,S77.Labels,...
    S87.Labels,S88.Labels,S89.Labels,...
    S94.Labels,S95.Labels,...
    S104.Labels,S105.Labels,...
    S113.Labels,...
    S1210.Labels,S1211.Labels,S1212.Labels,S1213.Labels,S1214.Labels,...
    S134.Labels,...
    S1417.Labels,S1418.Labels,S1419.Labels,S1420.Labels,S1421.Labels,S1422.Labels,S1423.Labels,...
    S153.Labels,...
    S1620.Labels,S1621.Labels,S1622.Labels,S1623.Labels,S1624.Labels,S1625.Labels,S1626.Labels,S1627.Labels,S1628.Labels,...
    S174.Labels,...
    S1814.Labels,S1815.Labels,S1816.Labels,S1817.Labels,S1818.Labels,S1819.Labels,...
    S194.Labels,...
    S2020.Labels,S2021.Labels,S2022.Labels,S2023.Labels,S2024.Labels,S2025.Labels,S2026.Labels,S2027.Labels,S2028.Labels,...
    S214.Labels,...
    S224.Labels,S225.Labels,...
    S2316.Labels,S2317.Labels,S2318.Labels,S2319.Labels,S2320.Labels,S2321.Labels,S2322.Labels,...
    S244.Labels,...
    S2529.Labels,S2530.Labels,S2531.Labels,S2532.Labels,S2533.Labels,S2534.Labels,S2535.Labels,S2536.Labels,...
    S2537.Labels,S2538.Labels,S2539.Labels,S2540.Labels,S2541.Labels,...
    S267.Labels,S268.Files,S269.Labels,...
    S274.Labels,...
    S283.Labels,...
    S292.Labels,...
    S303.Labels,...
    S315.Labels,...
    S323.Labels,...
    S335.Labels,S336.Labels,...
    S348.Labels,S349.Labels,S3410.Labels,...
    S355.Labels,S356.Labels,...
    S363.Labels,...
    S374.Labels,...
    S386.Labels,S387.Labels,...
    S396.Labels,S397.Labels,S398.Labels,...
    S4010.Labels,S4011.Labels,S4012.Labels,S4013.Labels,...
    S415.Labels,S416.Labels,...
    S425.Labels,S426.Labels,S427.Labels,...
    S433.Labels,S434.Labels,...
    S443.Labels);


    p4.Labels = cat(1,...
    S14.Labels,...
    S25.Labels,S26.Labels,...
    S34.Labels,S35.Labels,...
    S48.Labels,S49.Labels,...
    S57.Labels,...
    S67.Labels,...
    S78.Labels,S79.Labels,...
    S810.Labels,S811.Labels,S812.Labels,...
    S96.Labels,S97.Labels,...
    S106.Labels,...
    S114.Labels,...
    S1215.Labels,S1216.Labels,S1217.Labels,S1218.Labels,S1219.Labels,...
    S135.Labels,S136.Labels,...
    S1424.Labels,S1425.Labels,S1426.Labels,S1427.Labels,S1428.Labels,S1429.Labels,S1430.Labels,...
    S154.Labels,...
    S1629.Labels,S1630.Labels,S1631.Labels,S1632.Labels,S1633.Labels,S1634.Labels,S1635.Labels,S1636.Labels,S1637.Labels,...
    S175.Labels,...
    S1820.Labels,S1821.Labels,S1822.Labels,S1823.Labels,S1824.Labels,S1825.Labels,...
    S195.Labels,S196.Labels,...
    S2029.Labels,S2030.Labels,S2031.Labels,S2032.Labels,S2033.Labels,S2034.Labels,S2035.Labels,S2036.Labels,S2037.Labels,...
    S215.Labels,...
    S226.Labels,S227.Labels,...
    S2323.Labels,S2324.Labels,S2325.Labels,S2326.Labels,S2327.Labels,S2328.Labels,S2329.Labels,...
    S245.Labels,S246.Labels,...
    S2542.Labels,S2543.Labels,S2544.Labels,S2545.Labels,S2546.Labels,S2547.Labels,S2548.Labels,S2549.Labels,...
    S2550.Labels,S2551.Labels,S2552.Labels,S2553.Labels,S2554.Labels,...
    S2610.Labels,S2611.Labels,S2612.Labels,...
    S275.Labels,S276.Labels,...
    S284.Labels,...
    S295.Labels,...
    S304.Labels,...
    S316.Labels,S317.Labels,...
    S324.Labels,...
    S337.Labels,S338.Labels,...
    S3411.Labels,S3412.Labels,S3413.Labels,...
    S357.Labels,S358.Labels,S359.Labels,...
    S364.Labels,...
    S375.Labels,...
    S388.Labels,S389.Labels,S3810.Labels,...
    S399.Labels,S3910.Labels,S3911.Labels,...
    S4014.Labels,S4015.Labels,S4016.Labels,S4017.Labels,S4018.Labels,...
    S417.Labels,S418.Labels,S419.Labels,...
    S428.Labels,S429.Labels,S4210.Labels,...
    S435.Labels,S436.Labels,...
    S444.Labels);


    p5.Labels = cat(1,...
    S15.Labels,...
    S27.Labels,...
    S36.Labels,...
    S410.Labels,S411.Labels,...
    S58.Labels,S59.Labels,...
    S68.Labels,S69.Labels,...
    S710.Labels,S711.Labels,...
    S813.Labels,S814.Labels,...
    S98.Labels,...
    S107.Labels,S108.Labels,...
    S115.Labels,...
    S1220.Labels,S1221.Labels,S1222.Labels,S1223.Labels,...
    S137.Labels,...
    S1431.Labels,S1432.Labels,S1433.Labels,S1434.Labels,S1435.Labels,S1436.Labels,S1437.Labels,...
    S155.Labels,...
    S1638.Labels,S1639.Labels,S1640.Labels,S1641.Labels,S1642.Labels,S1643.Labels,S1644.Labels,S1645.Labels,S1646.Labels,S1647.Labels,...
    S176.Labels,...
    S1826.Labels,S1827.Labels,S1828.Labels,S1829.Labels,S1830.Labels,S1831.Labels,...
    S197.Labels,S198.Labels,...
    S2038.Labels,S2039.Labels,S2040.Labels,S2041.Labels,S2042.Labels,S2043.Labels,S2044.Labels,S2045.Labels,S2046.Labels,S2047.Labels,...
    S216.Labels,...
    S228.Labels,...
    S2330.Labels,S2331.Labels,S2332.Labels,S2333.Labels,S2334.Labels,S2335.Labels,S2336.Labels,S2337.Labels,...
    S247.Labels,...
    S2555.Labels,S2556.Labels,S2557.Labels,S2558.Labels,S2559.Labels,S2560.Labels,...
    S2561.Labels,S2562.Labels,S2563.Labels,S2564.Labels,S2565.Labels,S2566.Labels,S2567.Labels,...
    S2613.Labels,S2614.Labels,...
    S277.Labels,...
    S285.Labels,...
    S296.Labels,S297.Labels,...
    S305.Labels,...
    S318.Labels,S319.Labels,...
    S325.Labels,...
    S339.Labels,...
    S3414.Labels,S3415.Labels,S3416.Labels,S3417.Labels,...
    S3510.Labels,S3511.Labels,S3512.Labels,S3513.Labels,...
    S365.Labels,...
    S376.Labels,S377.Labels,...
    S3811.Labels,S3812.Labels,S3813.Labels,...
    S3912.Labels,S3913.Labels,S3914.Labels,...
    S4019.Labels,S4020.Labels,S4021.Labels,S4022.Labels,S4023.Labels,...
    S4110.Labels,S4111.Labels,S4112.Labels,S4113.Labels,...
    S4211.Labels,S4212.Labels,S4213.Labels,...
    S437.Labels,S438.Labels,...
    S445.Labels);

    partStores{1} = p1.Files;
    partStores{2} = p2.Files;
    partStores{3} = p3.Files;
    partStores{4} = p4.Files;
    partStores{5} = p5.Files;
%%check whether the distribution is alright 
numimds1 = numel(imds1.Files);
numimds2 = numel(imds2.Files);
numimds3 = numel(imds3.Files);
numimds4 = numel(imds4.Files);
numimds5 = numel(imds5.Files);
numimds6 = numel(imds6.Files);
numimds7 = numel(imds7.Files);
numimds8 = numel(imds8.Files);
numimds9 = numel(imds9.Files);
numimds10 = numel(imds10.Files);
numimds11 = numel(imds11.Files);
numimds12 = numel(imds12.Files);
numimds13 = numel(imds13.Files);
numimds14 = numel(imds14.Files);
numimds15 = numel(imds15.Files);
numimds16 = numel(imds16.Files);
numimds17 = numel(imds17.Files);
numimds18 = numel(imds18.Files);
numimds19 = numel(imds19.Files);
numimds20 = numel(imds20.Files);
numimds21 = numel(imds21.Files);
numimds22 = numel(imds22.Files);
numimds23 = numel(imds23.Files);
numimds24 = numel(imds24.Files);
numimds25 = numel(imds25.Files);
numimds26 = numel(imds26.Files);
numimds27 = numel(imds27.Files);
numimds28 = numel(imds28.Files);
numimds29 = numel(imds29.Files);
numimds30 = numel(imds30.Files);
numimds31 = numel(imds31.Files);
numimds32 = numel(imds32.Files);
numimds33 = numel(imds33.Files);
numimds34 = numel(imds34.Files);
numimds35 = numel(imds35.Files);
numimds36 = numel(imds36.Files);
numimds37 = numel(imds37.Files);
numimds38 = numel(imds38.Files);
numimds39 = numel(imds39.Files);
numimds40 = numel(imds40.Files);
numimds41 = numel(imds41.Files);
numimds42 = numel(imds42.Files);
numimds43 = numel(imds43.Files);
numimds44 = numel(imds44.Files);

a = numimds1+numimds2+numimds3+numimds4+numimds5+numimds6+numimds7+...
numimds8+numimds9+numimds10+numimds11+numimds12+numimds13+numimds14+numimds15+...
numimds16+numimds17+numimds18+numimds19+numimds20+numimds21+numimds22+numimds23+...
numimds24+numimds25+numimds26+numimds27+numimds28+numimds29+numimds30+numimds31+...
numimds32+numimds33+numimds34+numimds35+numimds36+numimds37+numimds38+numimds39+...
numimds40+numimds41+numimds42+numimds43+numimds44;

%%the above code is to generate 5 different testing set.
    k = 5;

    idx = crossvalind('Kfold', k, k);
%%choose the network, here are 4 networks. The first one is AlexNet
    net = alexnet;

    inputSize = net.Layers(1).InputSize;

    layersTransfer = net.Layers(1:end-3);
    
for i = 1:k
    
    test_idx = (idx == i);
    train_idx = ~test_idx;

    imdsValidation = imageDatastore(partStores{test_idx}, 'IncludeSubfolders', true, 'LabelSource', 'foldernames');
    imdsTrain = imageDatastore(cat(1, partStores{train_idx}), 'IncludeSubfolders', true, 'LabelSource', 'foldernames');

    numClasses = numel(categories(imdsTrain.Labels));

    layers = [
    layersTransfer
    fullyConnectedLayer(numClasses,'WeightLearnRateFactor',20,'BiasLearnRateFactor',20)
    softmaxLayer
    classificationLayer];

    scaleRange = [0.9 1.1];
    imageAugmenter = imageDataAugmenter(...
    'RandXScale',scaleRange, ...
    'RandYScale',scaleRange);

    augimdsTrain = augmentedImageDatastore(inputSize(1:2),imdsTrain,...
    'DataAugmentation',imageAugmenter);
    augimdsValidation = augmentedImageDatastore(inputSize(1:2),imdsValidation);
   %%here could be replaced by SGDM
    options = trainingOptions('adam', ...
    'MiniBatchSize',128, ...
    'MaxEpochs',100, ...
    'InitialLearnRate',0.0001, ...
    'Shuffle','every-epoch', ...
    'ValidationData',augimdsValidation, ...
    'ValidationFrequency',800, ...
    'Verbose',false, ...
    'Plots','training-progress');

    netTransfer{i} = trainNetwork(augimdsTrain,layers,options);
    [TPred{i},scores] = classify(netTransfer{i},augimdsValidation);
    ValidationLabel{i} = imdsValidation.Labels;
    TAccuracy{i} = mean(TPred{i} == ValidationLabel{i});
%     cm = confusionchart(ValidationLabel{i},TPred{i});
end

    Average = mean(cell2mat(TAccuracy));
    SDeviation = std(cell2mat(TAccuracy));
%%save and load
% load('All');
% save('All');

%% using GoogleNet
%%Load Pretrained Network, here could be replaced by ResNet-50 and inceptionv3
help freezeWeights
help findLayersToReplace
help createLgraphUsingConnections
    net = googlenet;
    inputSize = net.Layers(1).InputSize;
for i = 1:k
    
    test_idx = (idx == i);
    train_idx = ~test_idx;

    imdsValidation = imageDatastore(partStores{test_idx}, 'IncludeSubfolders', true, 'LabelSource', 'foldernames');
    imdsTrain = imageDatastore(cat(1, partStores{train_idx}), 'IncludeSubfolders', true, 'LabelSource', 'foldernames');
%%Replace Final Layers
%The convolutional layers of the network extract image features 
%that the last learnable layer and the final classification layer 
%use to classify the input image. These two layers, 'loss3-classifier' 
%and 'output' in GoogLeNet, contain information on how to combine the 
%features that the network extracts into class probabilities, a loss 
%value, and predicted labels. To retrain a pretrained network to 
%classify new images, replace these two layers with new layers adapted 
%to the new data set.

%Extract the layer graph from the trained network
    if isa(net,'SeriesNetwork') 
    lgraph = layerGraph(net.Layers); 
    else
    lgraph = layerGraph(net);
    end
    
%Find the names of the two layers to replace
    [learnableLayer,classLayer] = findLayersToReplace(lgraph);
    
%In most networks, the last layer with learnable weights is a 
%fully connected layer. Replace this fully connected layer with a 
%new fully connected layer with the number of outputs equal to the 
%number of classes in the new data set
    numClasses = numel(categories(imdsTrain.Labels));
    
    if isa(learnableLayer,'nnet.cnn.layer.FullyConnectedLayer')
    newLearnableLayer = fullyConnectedLayer(numClasses, ...
        'Name','new_fc', ...
        'WeightLearnRateFactor',10, ...
        'BiasLearnRateFactor',10);  
    elseif isa(learnableLayer,'nnet.cnn.layer.Convolution2DLayer')
    newLearnableLayer = convolution2dLayer(1,numClasses, ...
        'Name','new_conv', ...
        'WeightLearnRateFactor',10, ...
        'BiasLearnRateFactor',10);
    end
    
    lgraph = replaceLayer(lgraph,learnableLayer.Name,newLearnableLayer);
    
%The classification layer specifies the output classes of the network. 
%Replace the classification layer with a new one without class labels. 
%trainNetwork automatically sets the output classes of the layer 
%at training time.     
    newClassLayer = classificationLayer('Name','new_classoutput');
    lgraph = replaceLayer(lgraph,classLayer.Name,newClassLayer);
%%Freeze Initial Layers

%Extract the layers and connections of the layer graph and select 
%which layers to freeze. In GoogLeNet, the first 10 layers make out 
%the initial 'stem' of the network. During training, trainNetwork does 
%not update the parameters of the frozen layers. Because the gradients 
%of the frozen layers do not need to be computed, freezing the weights 
%of many initial layers can significantly speed up network training.
    layers = lgraph.Layers;
    connections = lgraph.Connections;
    
    layers(1:10) = freezeWeights(layers(1:10));
    lgraph = createLgraphUsingConnections(layers,connections);
%%imageDataAugmenter
    scaleRange = [0.9 1.1];
    imageAugmenter = imageDataAugmenter(...
    'RandXScale',scaleRange, ...
    'RandYScale',scaleRange);
%%resize images, augmentation
    augimdsTrain = augmentedImageDatastore(inputSize(1:2),imdsTrain,...
    'DataAugmentation',imageAugmenter);

    augimdsValidation = augmentedImageDatastore(inputSize(1:2),imdsValidation);
%%here could be replaced by SGDM
    options = trainingOptions('adam', ...
    'MiniBatchSize',128, ...
    'MaxEpochs',100, ...
    'InitialLearnRate',0.001, ...
    'Shuffle','every-epoch', ...
    'ValidationData',augimdsValidation, ...
    'ValidationFrequency',800, ...
    'Verbose',false, ...
    'Plots','training-progress');
%%Train Network
    netTransfer{i} = trainNetwork(augimdsTrain,lgraph,options);
    
    [TPred{i},scores] = classify(netTransfer{i},augimdsValidation);
    ValidationLabel{i} = imdsValidation.Labels;
    TAccuracy{i} = mean(TPred{i} == ValidationLabel{i});
%     cm = confusionchart(ValidationLabel{i},TPred{i});
end
    Average = mean(cell2mat(TAccuracy));
    SDeviation = std(cell2mat(TAccuracy));
%%Save and Load Variables
% load('All');
% save('All');
 
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

 